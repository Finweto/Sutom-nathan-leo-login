<html>

<link rel="stylesheet" type="text/css" href="/css/style.css" />

<body>
  <h1 id="name-storage"></h1>
  <h2 id="score-storage"></h2>
  <h1 id="todaysWordLength"></h1>
  <form id="sutom-form" action='post'>
    <input id="inputClient" type="text" name="clientWord">
    <input type="submit" value="Submit">
  </form>
  <span hidden id="word-of-the-day"></span>
  <div class="tables">
    <table id="foundWord"></table>
  </div>

  <form id="goToScore" type="submit">
    <input type="submit" value="Click to see your score">
  </form>
  <form id="logOut" type="submit">
    <input type="submit" value="Click to log out">
  </form>
</body>

</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

<script type="module">
  // initialiaze nbGuess
  let nbGuess = 1

  // ON LOAD
  $(document).ready(function () {

    // LOADING OF TODAY'S WORD
    $.get('/text', (data) => {

      // get word of the day
      const todaysWord = data.todaysWord
      console.log(todaysWord)

      // change hidden value to know word of the day for devs
      document.getElementById("word-of-the-day").innerHTML = todaysWord

      // fill table foundWord with unknown values to show length
      todaysWord.split('').forEach((element, index) => {
        $('#foundWord').append(`<td id=${index}></td>`)
      })

      // show today's word length to client
      document.getElementById("todaysWordLength").innerHTML = `La longueur du mot d'aujourd'hui est ${todaysWord.length}`

      // change attribute of forms
      document.getElementById("inputClient").setAttribute("maxlength", todaysWord.length)
      document.getElementById("inputClient").setAttribute("minlength", todaysWord.length)

      // notify today's word is loaded
      console.log('word of the day loaded !')
    })


    // show session Name
    if (sessionStorage.getItem('name')) {
      const sessionName = sessionStorage.getItem('name')
      document.getElementById('name-storage').innerHTML = `Bonjour ${sessionName}`
    }

    // SCORE STORAGE
    if (!sessionStorage.getItem('score')) {
      sessionStorage.setItem('score', 0)
    }
    const sessionScore = sessionStorage.getItem('score')
    document.getElementById('score-storage').innerHTML = `Votre score est : ${sessionScore}`
  })

  // GO TO SCORE
  document.getElementById("goToScore").addEventListener("submit", function (event) {
    event.preventDefault()
    console.log('redirection vers score micro service')

    document.location = 'http://localhost:3000/score'
  })

  // FEATURES OF MOTUS
  document.getElementById("sutom-form").addEventListener("submit", function (event) {
    event.preventDefault()

    // New array to keep history of tries
    const table = document.getElementById("foundWord")
    const newTable = table.cloneNode(true)
    newTable.id = "previousTry"
    table.after(newTable)

    // todays word tab
    const todaysWord = document.getElementById('word-of-the-day')
    const tabTodaysWord = todaysWord.innerHTML.split('')

    // clientInput 
    const clientInput = event.target[0].value
    const tabOfClientInput = clientInput.split('')

    // Let's compare the client guesses and the word of the day !
    // missing feature, can't see if multiple occurrence of letter in guess so will return the same response for two same letters
    tabOfClientInput.forEach((clientLetter, index) => {
      $(`#${index}`)[0].innerHTML = clientLetter
      if (clientLetter == tabTodaysWord[index]) {
        // good guess
        $(`#${index}`)[0].style.color = "green"
      } else if (tabTodaysWord.includes(clientLetter)) {
        // good but not on good index
        $(`#${index}`)[0].style.color = "orange"
      } else {
        // wrong
        $(`#${index}`)[0].style.color = "black"
      }
    })

    // check for win 
    if (clientInput === todaysWord.innerHTML) {

      // check for cheat
      if (clientInput != sessionName.getItem('previousWord')) {

        // change previousWord
        sessionStorage.setItem('previousWord', clientInput)

        // change score
        const sessionScore = sessionStorage.getItem('score')
        let newScore = parseInt(sessionScore)
        newScore++
        sessionScore.setItem('score', newScore)
        document.getElementById('score-storage').innerHTML = `Vous avez trouve ${newScore} mot`

        // set tries
        let nbTry = parseInt(sessionStorage.getItem("nbTry")) + 1;
        let avg = (parseInt(sessionStorage.getItem("avgTry")) * (nbTry - 1) + nbGuess) / nbTry;
        sessionStorage.setItem("nbTry", nbTry);
        sessionStorage.setItem("avgTry", avg);

        // add to scores
        let scores = JSON.parse(sessionStorage.getItem('scores'))
        scores.push({ mot: clientInput, tries: nbGuess })
        sessionStorage.setItem('scores', JSON.stringify(scores))

        // simple message win
        alert("VOUS AVEZ GAGNE")
      }

      else {
        // user is trying to guess the same word again to gain score
        alert("Vous avez déjà trouvé ce mot")
      }

    } else {
      nbGuess++
    }

  })

  document.getElementById("logOut").addEventListener("submit", function (event) {
    event.preventDefault()

    $.get('/logOut')
  })
</script>